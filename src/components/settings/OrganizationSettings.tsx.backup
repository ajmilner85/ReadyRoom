import React, { useState, useEffect } from 'react';
import { AlertCircle, Edit, Trash, X, Eye, EyeOff, Settings, MessageSquare, Building2 } from 'lucide-react';
import {
  Command,
  Group,
  Wing,
  Squadron,
  NewCommand,
  NewGroup,
  NewWing,
  NewSquadron
} from '../../types/OrganizationTypes';
import {
  getAllCommands,
  getAllGroups,
  getAllWings,
  getAllSquadrons,
  createCommand,
  createGroup,
  createWing,
  createSquadron,
  updateCommand,
  updateGroup,
  updateWing,
  updateSquadron,
  deleteCommand,
  deleteGroup,
  deleteWing,
  deleteSquadron,
  isEntityActive
} from '../../utils/organizationService';
import OrgEntityModal from './OrgEntityModal';

interface OrganizationSettingsProps {
  error?: string | null;
  setError?: (error: string | null) => void;
}

type OrgTab = 'branding' | 'discord' | 'definitions';

const OrganizationSettings: React.FC<OrganizationSettingsProps> = ({ error, setError }) => {
  // Tab state
  const [activeTab, setActiveTab] = useState<OrgTab>('definitions');
  
  // State for all organizational entities
  const [commands, setCommands] = useState<Command[]>([]);
  const [groups, setGroups] = useState<Group[]>([]);
  const [wings, setWings] = useState<Wing[]>([]);
  const [squadrons, setSquadrons] = useState<Squadron[]>([]);
  
  // UI state
  const [loading, setLoading] = useState(false);
  const [localError, setLocalError] = useState<string | null>(null);
  const [showInactive, setShowInactive] = useState(true);
  
  // Modal state
  const [modalState, setModalState] = useState<{
    isOpen: boolean;
    mode: 'create' | 'edit';
    entityType: 'command' | 'group' | 'wing' | 'squadron';
    entity?: Command | Group | Wing | Squadron;
  }>({
    isOpen: false,
    mode: 'create',
    entityType: 'command'
  });

  // Delete confirmation state
  const [deleteConfirmation, setDeleteConfirmation] = useState<{
    isOpen: boolean;
    entity?: Command | Group | Wing | Squadron;
    entityType?: 'command' | 'group' | 'wing' | 'squadron';
    confirmText: string;
  }>({
    isOpen: false,
    confirmText: ''
  });

  // Helper to set errors with parent component if available
  const setErrorMessage = (message: string | null) => {
    setLocalError(message);
    if (setError) {
      setError(message);
    }
  };

  // Load all organizational data
  const loadOrganizationData = async () => {
    setLoading(true);
    try {
      const [commandsResult, groupsResult, wingsResult, squadronsResult] = await Promise.all([
        getAllCommands(),
        getAllGroups(),
        getAllWings(),
        getAllSquadrons()
      ]);

      if (commandsResult.error) {
        console.error('Error loading commands:', commandsResult.error);
      } else if (commandsResult.data) {
        setCommands(commandsResult.data);
      }

      if (groupsResult.error) {
        console.error('Error loading groups:', groupsResult.error);
      } else if (groupsResult.data) {
        setGroups(groupsResult.data);
      }

      if (wingsResult.error) {
        console.error('Error loading wings:', wingsResult.error);
      } else if (wingsResult.data) {
        console.log('Wings loaded from database:', wingsResult.data);
        console.log('Wings data length:', wingsResult.data.length);
        if (wingsResult.data.length > 0) {
          console.log('First wing structure:', wingsResult.data[0]);
          console.log('First wing deactivated_date:', wingsResult.data[0].deactivated_date);
        }
        setWings(wingsResult.data);
      } else {
        console.log('No wings data returned from database');
      }

      if (squadronsResult.error) {
        console.error('Error loading squadrons:', squadronsResult.error);
      } else if (squadronsResult.data) {
        setSquadrons(squadronsResult.data);
      }
    } catch (err: any) {
      setErrorMessage(err.message);
      console.error('Error loading organization data:', err);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    loadOrganizationData();
  }, []);

  // Filter entities based on active status
  const filterEntities = <T extends { deactivated_date: string | null }>(entities: T[]): T[] => {
    if (showInactive) return entities;
    return entities.filter(isEntityActive);
  };

  // Handle opening create modal
  const handleCreateEntity = (entityType: 'command' | 'group' | 'wing' | 'squadron') => {
    console.log('handleCreateEntity called with:', entityType);
    setModalState({
      isOpen: true,
      mode: 'create',
      entityType,
      entity: undefined
    });
    console.log('Modal state set to:', { isOpen: true, mode: 'create', entityType });
  };

  // Handle opening edit modal
  const handleEditEntity = (entity: Command | Group | Wing | Squadron, entityType: 'command' | 'group' | 'wing' | 'squadron') => {
    setModalState({
      isOpen: true,
      mode: 'edit',
      entityType,
      entity
    });
  };

  // Handle modal save
  const handleModalSave = async (data: NewCommand | NewGroup | NewWing | NewSquadron) => {
    console.log('handleModalSave called');
    setLoading(true);
    try {
      if (modalState.mode === 'create') {
        let result: any;
        switch (modalState.entityType) {
          case 'command':
            result = await createCommand(data as NewCommand);
            if (result.data) setCommands([...commands, result.data]);
            break;
          case 'group':
            result = await createGroup(data as NewGroup);
            if (result.data) setGroups([...groups, result.data]);
            break;
          case 'wing':
            result = await createWing(data as NewWing);
            if (result.data) setWings([...wings, result.data]);
            break;
          case 'squadron':
            result = await createSquadron(data as NewSquadron);
            if (result.data) setSquadrons([...squadrons, result.data]);
            break;
        }
        
        if (result?.error) {
          throw new Error(result.error.message || `Failed to create ${modalState.entityType}`);
        }
      } else {
        // Edit mode
        if (!modalState.entity) return;
        
        let result: any;
        switch (modalState.entityType) {
          case 'command':
            result = await updateCommand(modalState.entity.id, data as NewCommand);
            if (result.data) {
              setCommands(commands.map(c => c.id === modalState.entity!.id ? result.data! : c));
            }
            break;
          case 'group':
            result = await updateGroup(modalState.entity.id, data as NewGroup);
            if (result.data) {
              setGroups(groups.map(g => g.id === modalState.entity!.id ? result.data! : g));
            }
            break;
          case 'wing':
            result = await updateWing(modalState.entity.id, data as NewWing);
            if (result.data) {
              setWings(wings.map(w => w.id === modalState.entity!.id ? result.data! : w));
            }
            break;
          case 'squadron':
            result = await updateSquadron(modalState.entity.id, data as NewSquadron);
            if (result.data) {
              setSquadrons(squadrons.map(s => s.id === modalState.entity!.id ? result.data! : s));
            }
            break;
        }
        
        if (result?.error) {
          throw new Error(result.error.message || `Failed to update ${modalState.entityType}`);
        }
      }
      
      setModalState({ ...modalState, isOpen: false });
    } catch (err: any) {
      setErrorMessage(err.message);
    } finally {
      setLoading(false);
    }
  };

  // Handle delete entity
  const handleDeleteEntity = (entity: Command | Group | Wing | Squadron, entityType: 'command' | 'group' | 'wing' | 'squadron') => {
    setDeleteConfirmation({
      isOpen: true,
      entity,
      entityType,
      confirmText: ''
    });
  };

  // Confirm delete
  const confirmDelete = async () => {
    if (!deleteConfirmation.entity || !deleteConfirmation.entityType) return;
    if (deleteConfirmation.confirmText.toLowerCase() !== 'yes') {
      setErrorMessage('Please type "yes" to confirm deletion');
      return;
    }

    setLoading(true);
    try {
      let result: any;
      const entityId = deleteConfirmation.entity.id;
      
      switch (deleteConfirmation.entityType) {
        case 'command':
          result = await deleteCommand(entityId);
          if (result.success) {
            setCommands(commands.filter(c => c.id !== entityId));
          }
          break;
        case 'group':
          result = await deleteGroup(entityId);
          if (result.success) {
            setGroups(groups.filter(g => g.id !== entityId));
          }
          break;
        case 'wing':
          result = await deleteWing(entityId);
          if (result.success) {
            setWings(wings.filter(w => w.id !== entityId));
          }
          break;
        case 'squadron':
          result = await deleteSquadron(entityId);
          if (result.success) {
            setSquadrons(squadrons.filter(s => s.id !== entityId));
          }
          break;
      }
      
      if (result?.error) {
        throw new Error(result.error.message || `Failed to delete ${deleteConfirmation.entityType}`);
      }
      
      setDeleteConfirmation({ isOpen: false, confirmText: '' });
    } catch (err: any) {
      setErrorMessage(err.message);
    } finally {
      setLoading(false);
    }
  };

  const addButtonStyle = {
    width: '119px',
    height: '30px',
    background: '#FFFFFF',
    borderRadius: '8px',
    border: 'none',
    cursor: 'pointer',
    transition: 'box-shadow 0.2s ease-in-out',
    fontFamily: 'Inter',
    fontStyle: 'normal',
    fontWeight: 400,
    fontSize: '20px',
    lineHeight: '24px',
    color: '#64748B',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    marginTop: '10px',
    marginLeft: 'auto',
    marginRight: 'auto'
  };

  const containerStyle = {
    backgroundColor: '#FFFFFF',
    minHeight: '100vh',
    padding: '40px',
    boxSizing: 'border-box' as const
  };

  const contentWrapperStyle = {
    maxWidth: '800px',
    margin: '0 auto'
  };

  const headerStyle = {
    marginBottom: '40px',
    display: 'flex',
    justifyContent: 'space-between',
    alignItems: 'flex-start'
  };

  const sectionStyle = {
    paddingTop: '32px',
    paddingBottom: '32px',
    borderTop: '1px solid #E5E7EB',
    marginTop: '32px'
  };

  const firstSectionStyle = {
    paddingTop: '0',
    paddingBottom: '32px',
    marginTop: '0',
    borderTop: 'none'
  };

  // Tab configuration
  const tabs = [
    {
      id: 'branding' as OrgTab,
      label: 'Branding & Identity',
      icon: <Building2 size={16} />
    },
    {
      id: 'discord' as OrgTab,
      label: 'Discord Integration',
      icon: <MessageSquare size={16} />
    },
    {
      id: 'definitions' as OrgTab,
      label: 'Organization Definitions',
      icon: <Settings size={16} />
    }
  ];

  // Render tab content based on active tab
  const renderTabContent = () => {
    switch (activeTab) {
      case 'branding':
        return renderBrandingTab();
      case 'discord':
        return renderDiscordTab();
      case 'definitions':
        return renderDefinitionsTab();
      default:
        return null;
    }
  };

  // Branding tab content (placeholder for now)
  const renderBrandingTab = () => (
    <div style={{ padding: '24px 0' }}>
      <h3 style={{ fontSize: '18px', fontWeight: 600, color: '#0F172A', margin: '0 0 16px 0' }}>
        Branding & Identity Settings
      </h3>
      <p style={{ fontSize: '14px', color: '#64748B', fontFamily: 'Inter' }}>
        Organization branding and identity settings will be implemented here.
      </p>
    </div>
  );

  // Discord integration tab content
  const renderDiscordTab = () => (
    <div style={{ padding: '24px 0' }}>
      <h3 style={{ fontSize: '18px', fontWeight: 600, color: '#0F172A', margin: '0 0 16px 0' }}>
        Discord Role Mapping
      </h3>
      <p style={{ fontSize: '14px', color: '#64748B', fontFamily: 'Inter', marginBottom: '24px' }}>
        Configure how Discord roles map to application permissions and access levels.
      </p>
      
      {/* Role mapping interface will be implemented here */}
      <div style={{
        padding: '24px',
        backgroundColor: '#F8FAFC',
        borderRadius: '8px',
        border: '1px solid #E2E8F0'
      }}>
        <p style={{ fontSize: '14px', color: '#64748B', fontFamily: 'Inter', textAlign: 'center' }}>
          Discord Role Mapping Interface will be implemented here
        </p>
      </div>
    </div>
  );

  // Definitions tab content (existing org hierarchy)
  const renderDefinitionsTab = () => (
    <div>
      {/* Header for definitions tab */}
      <div style={{
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'flex-start',
        marginBottom: '32px'
      }}>
        <div>
          <h3 style={{ fontSize: '18px', fontWeight: 600, color: '#0F172A', margin: '0 0 8px 0' }}>
            Organization Definitions
          </h3>
          <p style={{ fontSize: '14px', color: '#64748B', margin: 0, fontFamily: 'Inter' }}>
            Configure your organizational hierarchy and entities.
          </p>
        </div>
        
        <button
          onClick={() => setShowInactive(!showInactive)}
          style={{
            display: 'flex',
            alignItems: 'center',
            gap: '8px',
            padding: '8px 12px',
            backgroundColor: '#FFFFFF',
            border: '1px solid #D1D5DB',
            borderRadius: '6px',
            cursor: 'pointer',
            fontSize: '14px',
            fontFamily: 'Inter',
            color: '#374151',
            transition: 'background-color 0.2s ease'
          }}
          title={showInactive ? "Hide inactive entities" : "Show inactive entities"}
          onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#F8FAFC'}
          onMouseLeave={(e) => e.currentTarget.style.backgroundColor = '#FFFFFF'}
        >
          {showInactive ? <EyeOff size={16} /> : <Eye size={16} />}
          <span>
            {showInactive ? 'Hide Inactive' : 'Show Inactive'}
          </span>
        </button>
      </div>

      {/* Existing organization hierarchy content */}
      {loading && (
        <div style={{
          textAlign: 'center',
          padding: '32px 0',
          color: '#64748B',
          fontFamily: 'Inter',
          fontSize: '14px'
        }}>
          Loading organization data...
        </div>
      )}

      {!loading && (
        <>
          {/* Commands Level */}
          <div style={firstSectionStyle}>
          <div style={{
            padding: '16px',
            marginBottom: '24px',
            backgroundColor: '#FEF2F2',
            border: '1px solid #FECACA',
            color: '#DC2626',
            borderRadius: '6px',
            display: 'flex',
            alignItems: 'center',
            fontFamily: 'Inter',
            fontSize: '14px'
          }} role="alert">
            <AlertCircle size={18} style={{ marginRight: '8px' }} />
            <span>{error || localError}</span>
            <button onClick={() => setErrorMessage(null)} style={{
              marginLeft: 'auto',
              background: 'none',
              border: 'none',
              cursor: 'pointer',
              padding: '4px'
            }}>
              <X size={16} />
            </button>
          </div>
        )}

        {loading && (
          <div style={{
            textAlign: 'center',
            padding: '32px 0',
            color: '#64748B',
            fontFamily: 'Inter',
            fontSize: '14px'
          }}>
            Loading organization data...
          </div>
        )}

        {!loading && (
          <>
            {/* Commands Level */}
            <div style={firstSectionStyle}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                <h3 style={{ fontSize: '18px', fontWeight: 600, color: '#0F172A', margin: 0 }}>
                  Commands
                </h3>
                <span style={{ fontSize: '14px', color: '#64748B', fontFamily: 'Inter' }}>
                  {filterEntities(commands).length} active
                </span>
              </div>
            
            {filterEntities(commands).length === 0 ? (
              <div className="text-center py-8 text-slate-500">
                <p className="mb-4">No commands configured</p>
                <button
                  onClick={() => handleCreateEntity('command')}
                  style={addButtonStyle}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.boxShadow = '0px 10px 15px -3px rgba(0, 0, 0, 0.25), 0px 4px 6px -4px rgba(0, 0, 0, 0.1)';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.boxShadow = 'none';
                  }}
                >
                  +
                </button>
              </div>
            ) : (
              <>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                  {filterEntities(commands).map(command => (
                    <div
                      key={command.id}
                      className={`p-4 border rounded-lg ${!isEntityActive(command) ? 'opacity-60 bg-slate-50' : 'bg-white'}`}
                    >
                      <div className="flex justify-between items-start mb-2">
                        <h4 className="font-medium text-slate-900">{command.name}</h4>
                        <div className="flex gap-1">
                          <button
                            onClick={() => handleEditEntity(command, 'command')}
                            className="p-1 hover:bg-slate-100 rounded"
                            title="Edit"
                          >
                            <Edit size={14} className="text-slate-600" />
                          </button>
                          <button
                            onClick={() => handleDeleteEntity(command, 'command')}
                            className="p-1 hover:bg-red-100 rounded"
                            title="Delete"
                          >
                            <Trash size={14} className="text-red-600" />
                          </button>
                        </div>
                      </div>
                      {command.established_date && (
                        <p className="text-xs text-slate-500">
                          Est. {new Date(command.established_date).getFullYear()}
                        </p>
                      )}
                      {!isEntityActive(command) && (
                        <p className="text-xs text-red-500 mt-1">Deactivated</p>
                      )}
                    </div>
                  ))}
                </div>
                <button
                  onClick={() => handleCreateEntity('command')}
                  style={addButtonStyle}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.boxShadow = '0px 10px 15px -3px rgba(0, 0, 0, 0.25), 0px 4px 6px -4px rgba(0, 0, 0, 0.1)';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.boxShadow = 'none';
                  }}
                >
                  +
                </button>
              </>
            )}
            </div>

            {/* Groups Level */}
            <div style={sectionStyle}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                <h3 style={{ fontSize: '18px', fontWeight: 600, color: '#0F172A', margin: 0 }}>
                  Groups
                </h3>
                <span style={{ fontSize: '14px', color: '#64748B', fontFamily: 'Inter' }}>
                  {filterEntities(groups).length} active
                </span>
              </div>
            
            {filterEntities(groups).length === 0 ? (
              <div className="text-center py-8 text-slate-500">
                <p className="mb-4">No groups configured</p>
                <button
                  onClick={() => handleCreateEntity('group')}
                  style={addButtonStyle}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.boxShadow = '0px 10px 15px -3px rgba(0, 0, 0, 0.25), 0px 4px 6px -4px rgba(0, 0, 0, 0.1)';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.boxShadow = 'none';
                  }}
                >
                  +
                </button>
              </div>
            ) : (
              <>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                  {filterEntities(groups).map(group => (
                    <div
                      key={group.id}
                      className={`p-4 border rounded-lg ${!isEntityActive(group) ? 'opacity-60 bg-slate-50' : 'bg-white'}`}
                    >
                      <div className="flex justify-between items-start mb-2">
                        <h4 className="font-medium text-slate-900">{group.name}</h4>
                        <div className="flex gap-1">
                          <button
                            onClick={() => handleEditEntity(group, 'group')}
                            className="p-1 hover:bg-slate-100 rounded"
                            title="Edit"
                          >
                            <Edit size={14} className="text-slate-600" />
                          </button>
                          <button
                            onClick={() => handleDeleteEntity(group, 'group')}
                            className="p-1 hover:bg-red-100 rounded"
                            title="Delete"
                          >
                            <Trash size={14} className="text-red-600" />
                          </button>
                        </div>
                      </div>
                      {group.command && (
                        <p className="text-xs text-slate-600 mb-1">
                          {group.command.name}
                        </p>
                      )}
                      {group.established_date && (
                        <p className="text-xs text-slate-500">
                          Est. {new Date(group.established_date).getFullYear()}
                        </p>
                      )}
                      {!isEntityActive(group) && (
                        <p className="text-xs text-red-500 mt-1">Deactivated</p>
                      )}
                    </div>
                  ))}
                </div>
                <button
                  onClick={() => handleCreateEntity('group')}
                  style={addButtonStyle}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.boxShadow = '0px 10px 15px -3px rgba(0, 0, 0, 0.25), 0px 4px 6px -4px rgba(0, 0, 0, 0.1)';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.boxShadow = 'none';
                  }}
                >
                  +
                </button>
              </>
            )}
            </div>

            {/* Wings Level */}
            <div style={sectionStyle}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                <h3 style={{ fontSize: '18px', fontWeight: 600, color: '#0F172A', margin: 0 }}>
                  Wings
                </h3>
                <span style={{ fontSize: '14px', color: '#64748B', fontFamily: 'Inter' }}>
                  {filterEntities(wings).length} active
                </span>
              </div>
            
            {(() => {
              const filtered = filterEntities(wings);
              console.log('Wings before filter:', wings);
              console.log('Wings after filter:', filtered);
              console.log('showInactive:', showInactive);
              return filtered.length === 0;
            })() ? (
              <div className="text-center py-8 text-slate-500">
                <p className="mb-4">No wings configured</p>
                <button
                  onClick={() => handleCreateEntity('wing')}
                  style={addButtonStyle}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.boxShadow = '0px 10px 15px -3px rgba(0, 0, 0, 0.25), 0px 4px 6px -4px rgba(0, 0, 0, 0.1)';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.boxShadow = 'none';
                  }}
                >
                  +
                </button>
              </div>
            ) : (
              <>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                  {filterEntities(wings).map(wing => (
                    <div
                      key={wing.id}
                      className={`p-4 border rounded-lg ${!isEntityActive(wing) ? 'opacity-60 bg-slate-50' : 'bg-white'}`}
                    >
                      <div className="flex justify-between items-start mb-2">
                        <div>
                          <h4 className="font-medium text-slate-900">{wing.name}</h4>
                          {wing.designation && (
                            <p className="text-sm text-slate-600">{wing.designation}</p>
                          )}
                        </div>
                        <div className="flex gap-1">
                          <button
                            onClick={() => handleEditEntity(wing, 'wing')}
                            className="p-1 hover:bg-slate-100 rounded"
                            title="Edit"
                          >
                            <Edit size={14} className="text-slate-600" />
                          </button>
                          <button
                            onClick={() => handleDeleteEntity(wing, 'wing')}
                            className="p-1 hover:bg-red-100 rounded"
                            title="Delete"
                          >
                            <Trash size={14} className="text-red-600" />
                          </button>
                        </div>
                      </div>
                      {wing.group && (
                        <p className="text-xs text-slate-600 mb-1">
                          {wing.group.command?.name ? `${wing.group.command.name} > ` : ''}{wing.group.name}
                        </p>
                      )}
                      {wing.tail_code && (
                        <p className="text-xs text-slate-600 mb-1">
                          Tail Code: {wing.tail_code}
                        </p>
                      )}
                      {wing.established_date && (
                        <p className="text-xs text-slate-500">
                          Est. {new Date(wing.established_date).getFullYear()}
                        </p>
                      )}
                      {!isEntityActive(wing) && (
                        <p className="text-xs text-red-500 mt-1">Deactivated</p>
                      )}
                    </div>
                  ))}
                </div>
                <button
                  onClick={() => handleCreateEntity('wing')}
                  style={addButtonStyle}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.boxShadow = '0px 10px 15px -3px rgba(0, 0, 0, 0.25), 0px 4px 6px -4px rgba(0, 0, 0, 0.1)';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.boxShadow = 'none';
                  }}
                >
                  +
                </button>
              </>
            )}
            </div>

            {/* Squadrons Level */}
            <div style={sectionStyle}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                <h3 style={{ fontSize: '18px', fontWeight: 600, color: '#0F172A', margin: 0 }}>
                  Squadrons
                </h3>
                <span style={{ fontSize: '14px', color: '#64748B', fontFamily: 'Inter' }}>
                  {filterEntities(squadrons).length} active
                </span>
              </div>
            
            {filterEntities(squadrons).length === 0 ? (
              <div className="text-center py-8 text-slate-500">
                <p className="mb-4">No squadrons configured</p>
                <button
                  onClick={() => handleCreateEntity('squadron')}
                  style={addButtonStyle}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.boxShadow = '0px 10px 15px -3px rgba(0, 0, 0, 0.25), 0px 4px 6px -4px rgba(0, 0, 0, 0.1)';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.boxShadow = 'none';
                  }}
                >
                  +
                </button>
              </div>
            ) : (
              <>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                  {filterEntities(squadrons).map(squadron => (
                    <div
                      key={squadron.id}
                      className={`p-4 border rounded-lg ${!isEntityActive(squadron) ? 'opacity-60 bg-slate-50' : 'bg-white'}`}
                    >
                      <div className="flex justify-between items-start mb-2">
                        <div>
                          <h4 className="font-medium text-slate-900">{squadron.name}</h4>
                          <p className="text-sm text-slate-600">{squadron.designation}</p>
                        </div>
                        <div className="flex gap-1">
                          <button
                            onClick={() => handleEditEntity(squadron, 'squadron')}
                            className="p-1 hover:bg-slate-100 rounded"
                            title="Edit"
                          >
                            <Edit size={14} className="text-slate-600" />
                          </button>
                          <button
                            onClick={() => handleDeleteEntity(squadron, 'squadron')}
                            className="p-1 hover:bg-red-100 rounded"
                            title="Delete"
                          >
                            <Trash size={14} className="text-red-600" />
                          </button>
                        </div>
                      </div>
                      {squadron.wing && (
                        <p className="text-xs text-slate-600 mb-1">
                          {squadron.wing.group?.command?.name ? `${squadron.wing.group.command.name} > ` : ''}
                          {squadron.wing.group ? `${squadron.wing.group.name} > ` : ''}
                          {squadron.wing.name}
                        </p>
                      )}
                      {squadron.tail_code && (
                        <p className="text-xs text-slate-600 mb-1">
                          Tail Code: {squadron.tail_code}
                        </p>
                      )}
                      {squadron.established_date && (
                        <p className="text-xs text-slate-500">
                          Est. {new Date(squadron.established_date).getFullYear()}
                        </p>
                      )}
                      {!isEntityActive(squadron) && (
                        <p className="text-xs text-red-500 mt-1">Deactivated</p>
                      )}
                    </div>
                  ))}
                </div>
                <button
                  onClick={() => handleCreateEntity('squadron')}
                  style={addButtonStyle}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.boxShadow = '0px 10px 15px -3px rgba(0, 0, 0, 0.25), 0px 4px 6px -4px rgba(0, 0, 0, 0.1)';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.boxShadow = 'none';
                  }}
                >
                  +
                </button>
              </>
            )}
            </div>
          </>
        )}

      {/* Modal for creating/editing entities */}
      <OrgEntityModal
        isOpen={modalState.isOpen}
        mode={modalState.mode}
        entityType={modalState.entityType}
        entity={modalState.entity}
        commands={commands}
        groups={groups}
        wings={wings}
        onSave={handleModalSave}
        onClose={() => {
          console.log('Modal onClose called');
          setModalState({ ...modalState, isOpen: false });
        }}
      />

      {/* Delete confirmation modal */}
      {deleteConfirmation.isOpen && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white p-6 rounded-lg w-96">
            <h3 className="text-lg font-semibold mb-4">Confirm Deletion</h3>
            <p className="text-slate-600 mb-4">
              Are you sure you want to delete this {deleteConfirmation.entityType}? This action cannot be undone.
            </p>
            <p className="text-sm text-slate-500 mb-4">
              Type "yes" to confirm:
            </p>
            <input
              type="text"
              value={deleteConfirmation.confirmText}
              onChange={(e) => setDeleteConfirmation({
                ...deleteConfirmation,
                confirmText: e.target.value
              })}
              className="w-full px-3 py-2 border border-slate-300 rounded mb-4"
              placeholder="Type 'yes' to confirm"
            />
            <div className="flex justify-end gap-3">
              <button
                onClick={() => setDeleteConfirmation({ isOpen: false, confirmText: '' })}
                className="px-4 py-2 bg-slate-200 text-slate-700 rounded hover:bg-slate-300"
              >
                Cancel
              </button>
              <button
                onClick={confirmDelete}
                disabled={deleteConfirmation.confirmText.toLowerCase() !== 'yes'}
                className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                Delete
              </button>
            </div>
          </div>
        </div>
      )}

      </div>
    </div>
  );
};

export default OrganizationSettings;